name: CI
on:
  push:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: false
jobs:
  build:
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v1.0.0

    - name: Setup helmfile
      uses: mamezou-tech/setup-helmfile@v1.0.0

    - name: Set up helmfile config
      run: cp .github/environments.yaml environments.yaml

    - name: Run helmfile template
      run: |
        helmfile template

    - name: Start a local k8s cluster
      uses: jupyterhub/action-k3s-helm@v3
      with:
        # See available:
        # - k3s release channels at https://github.com/k3s-io/k3s/blob/HEAD/channel.yaml
        # - k3s versions at https://github.com/k3s-io/k3s/tags
        # - helm versions at https://github.com/helm/helm/tags
        k3s-channel: latest

    - name: Verify function of k8s, kubectl, and helm
      run: |
        echo "kubeconfig: $KUBECONFIG"
        kubectl version
        kubectl get pods --all-namespaces

        helmfile sync --concurrency 1

    # Enable tmate debugging of manually-triggered workflows if the input option was provided
    - name: Manually triggered tmate session
      uses: mxschmitt/action-tmate@v3
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
      with:
        limit-access-to-actor: true

    - name: Setup tmate session if jobs have failed
      if: ${{ failure() }}
      uses: mxschmitt/action-tmate@v3
      timeout-minutes: 15
      with:
        limit-access-to-actor: true
