#!/bin/bash

cd "$(dirname "${BASH_SOURCE[0]}")/.."
. bin/util.sh

function createKeyStore() {
  keystorefile="$1"
  keytoolOpts=(-keystore "${keystorefile}" -storepass radarbase -keypass radarbase $KEYSTORE_OPTS)

  if ! keytool -list "${keytoolOpts[@]}" -alias radarbase-managementportal-ec >/dev/null 2>/dev/null; then
    echo "--> Generating keystore to hold EC keypair for JWT signing"
    createOpts=(-genkeypair -alias radarbase-managementportal-ec -keyalg EC -groupname secp256r1 -sigalg SHA256withECDSA -storetype PKCS12 $KEYSTORE_CREATE_OPTS)
    if [ -n "${DNAME}" ]; then
      createOpts+=(-dname "${DNAME}")
    fi
    keytool "${createOpts[@]}" "${keytoolOpts[@]}"
    echo
  else
    echo "--> ECDSA keypair for signing JWTs already exists. Not creating a new one."
  fi

  if ! keytool -list "${keytoolOpts[@]}" -alias selfsigned >/dev/null 2>/dev/null; then
    echo "--> Generating keystore to hold RSA keypair for JWT signing"
    createOpts=(-genkeypair -alias selfsigned -keyalg RSA -keysize 4096 -storetype PKCS12 $KEYSTORE_CREATE_OPTS)
    if [ -n "${DNAME}" ]; then
      createOpts+=(-dname "${DNAME}")
    fi
    keytool "${createOpts[@]}" "${keytoolOpts[@]}"
    echo
  else
    echo "--> RSA keypair for signing JWTs already exists. Not creating a new one."
  fi

  if [ ! -e "${keystorefile}" ]; then
    >&2 echo "FAILED TO CREATE KEYSTORE FILE $keystorefile"
    exit 1
  fi

  if ! keytool -list "${keytoolOpts[@]}" -alias radarbase-managementportal-ec >/dev/null 2>/dev/null; then
    >&2 echo "FAILED TO CREATE ECDSA KEY radarbase-managementportal-ec in $keystorefile. Please try again."
    rm "${keystorefile}"
    exit 1
  fi

  if ! keytool -list "${keytoolOpts[@]}" -alias selfsigned >/dev/null 2>/dev/null; then
    >&2 echo "FAILED TO CREATE RSA KEY selfsigned in $keystorefile. Please try again."
    rm "${keystorefile}"
    exit 1
  fi

  chmod 400 "${keystorefile}"
}

if [ ! -f etc/management-portal/keystore.p12 ]; then
  mkdir -p etc/management-portal
  
  if [ -f etc/keystore.p12 ]; then
    cp etc/keystore.p12 etc/management-portal/keystore.p12
  fi
fi

createKeyStore etc/management-portal/keystore.p12
