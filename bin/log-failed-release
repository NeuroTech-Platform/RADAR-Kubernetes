#!/usr/bin/env bash

cd "$(dirname "${BASH_SOURCE[0]}")/.."
. bin/util.sh

kubeContext="$1"
releaseNamespace="${2:-default}"
releaseName="$3"
error="$4"

echo "kubeContext=$kubeContext"
echo "releaseNamespace=$releaseNamespace"
echo "releaseName=$releaseName"
echo "error=$error"

if [ -z "$error" ]; then
  echo "status=success"
elif kubectl --context $kubeContext --namespace $releaseNamespace get pods -l "app.kubernetes.io/instance=$releaseName" -o yaml | yq " .items[].status.containerStatuses[].ready" | grep -vq false; then
  echo "status=ready"
else
  echo "status=not ready"
  echo
  echo "------------------------ Namespace status ------------------------"
  kubectl --context $kubeContext --namespace $releaseNamespace get pods -o wide
  echo "------------------------ Pod status ------------------------"
  kubectl --context $kubeContext --namespace $releaseNamespace get pods -l "app.kubernetes.io/instance=$releaseName" -o yaml
  echo "------------------------ Previous logs ------------------------"
  kubectl --context $kubeContext --namespace $releaseNamespace logs --previous=true --ignore-errors=true --all-containers=true --prefix=true --timestamps=true --tail=100 -l "app.kubernetes.io/instance=$releaseName"
  echo "------------------------ Curent logs ------------------------"
  kubectl --context $kubeContext --namespace $releaseNamespace logs --ignore-errors=true --all-containers=true --prefix=true --timestamps=true --tail=100 -l "app.kubernetes.io/instance=$releaseName"
fi
